var __extends=this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);i.prototype=t.prototype,e.prototype=new i};define(["require","exports","./BaseGenerator"],function(require,exports,BaseGenerator){function _toHtml(e){return String(e||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}var TypeScriptGenerator=function(_super){function TypeScriptGenerator(){_super.apply(this,arguments)}return __extends(TypeScriptGenerator,_super),TypeScriptGenerator.prototype.generate=function(e){{var t=this,i=this.template=t._getTemplate(e);"I"+i.name+"Model"}if(i.viewModelType&&t._addLine("import "+i.viewModelType+" = require('"+i.viewModelType+"');"),t._addImports(i),i.cssInclude){var n=i.cssInclude.replace(".","");t._addLine("import DomUtils = require('DomUtils');"),t._addLine("import "+n+" = require('"+i.cssInclude+"');"),t._addLine(),t._addLine("DomUtils.loadStyles("+n+".styles);")}return t._addClass(i),t._addLine(),t._addLine("export = "+i.name+";"),t.output},TypeScriptGenerator.prototype._addClass=function(e){for(var t=0;t<e.subTemplates.length;t++)this._addClass(e.subTemplates[t]);this._addLine(),this._addLine("class "+e.name+" extends "+e.baseViewType+" {"),this._addProperties(e),this._addOnInitialize(e),this._addOnViewModelChanged(e),this._addOnRenderElement(e),this._addAnnotations(e),this._addLine("}")},TypeScriptGenerator.prototype._addImports=function(e){function t(e){var n;for(var a in e.childViews){var r=e.childViews[a];r.shouldImport&&(i[r.type]=r),i[r.baseType]=r}for(n=0;n<e.subTemplates.length;n++)t(e.subTemplates[n]);for(n=0;n<e.requireList.length;n++)i[e.requireList[n]]=null}var i={View:{}};i[e.baseViewType]=e,t(e);for(var n in i){var a=n.replace(".","");this._addLine("import "+a+" = require('"+n+"');"),i[n]||this._addLine(a+";")}},TypeScriptGenerator.prototype._addOnInitialize=function(e){var t,i,n=!1;for(i in e.childViews)if(t=e.childViews[i].template,t.isPassThrough){n=!0;break}if(n){this._addLine(),this._addLine("onInitialize() {",1),this._addLine("super.onInitialize();",2);for(i in e.childViews)t=e.childViews[i].template,t.isPassThrough&&this._addLine("this."+i+".owner = "+(e.parentTemplate?"this.owner":"this")+";",2);this._addLine("}",1)}},TypeScriptGenerator.prototype._addOnViewModelChanged=function(e){var t,i=this,n=!1;for(t in e.childViews)if(e.childViews[t].data){n=!0;break}if(n){i._addLine(),i._addLine("onViewModelChanged() {",1),this._addLine("super.onViewModelChanged();",2);for(var t in e.childViews){var a=e.childViews[t];if(a.data){var r=a.data;if(0==r.indexOf("{")){r=r.substr(1,r.length-2);var d=r.split(","),o=!0;r="{";for(var s=0;s<d.length;s++){var p=d[s].trim().split(/[\s:]+/);r+=(o?"":",")+" "+p[0].trim()+": this.getValue('"+p[1].trim()+"')",o=!1}r+=" }"}else r="this.getValue('"+r+"')";this._addLine("this."+t+".setData("+r+");",2)}}i._addLine("}",1)}},TypeScriptGenerator.prototype._addProperties=function(template){if(this._addLine("viewName = '"+template.name+"';",1),template.options){var optionsBag=eval("("+template.options+")");for(var optionName in optionsBag)this._addLine(optionName+" = "+optionsBag[optionName]+";",1)}template.viewModelType&&this._addLine("viewModelType = "+template.viewModelType+";",1);for(var memberName in template.childViews){var childViewDefinition=template.childViews[memberName];this._addLine(memberName+" = <any>this.addChild(new "+childViewDefinition.type+"());",1)}},TypeScriptGenerator.prototype._addOnRenderElement=function(e){var t=this;t._addLine(),t._addLine("onRenderElement(): HTMLElement {",1),t._addLine("var _this = this;",2),t._addLine("var bindings = _this._bindings;",2),t._addLine(),this._addChildElements(e.documentElement,2),t._addLine("}",1)},TypeScriptGenerator.prototype._addChildElements=function(e,t){for(var i="js-view"===e.tagName,n=i?"return (_this.element = ":"",a=0;a<e.childNodes.length;a++){var r=e.childNodes[a],d=r.annotation,o=d?"bindings["+d.id+"]":null,s=a==e.childNodes.length-1?i?");":"":",";if("js-view"===r.tagName)this._addLine(n+"_this."+r.getAttribute("js-name")+".renderElement()"+s,t);else if(r.nodeType===e.ELEMENT_NODE){for(var p=[],l=0;l<r.attributes.length;l++)p.push(r.attributes[l].name),p.push(r.attributes[l].value);var h=r.childNodes.length>0,_=h?", [":")"+s,u=h;h&&"js-items"==r.childNodes[0].tagName&&(u=!1,_=", this.getChildElements())"+s),this._addLine(n+'_this._ce("'+r.tagName+'", '+JSON.stringify(p)+(o||h?", "+o:"")+_,t),u&&(this._addChildElements(r,t+1),this._addLine("])"+s,t))}else r.nodeType===e.TEXT_NODE&&this._addLine("_this._ct("+JSON.stringify(r.textContent)+")"+s,t)}},TypeScriptGenerator.prototype._addOnRenderHtml=function(e){var t=this;t._addLine(),t._addLine("onRenderHtml(): string {",1),t._addLine("return '' +",2),this._addChildNodes(e.documentElement,3),t._addLine("'';",3),t._addLine("}",1)},TypeScriptGenerator.prototype._addChildNodes=function(e,t){for(var i=0;i<e.childNodes.length;i++){var n=e.childNodes[i];if(n.nodeType===e.ELEMENT_NODE)this._addRenderLine(n,t);else if(n.nodeType===e.TEXT_NODE){var a=n.textContent.trim();a&&this._addLine("'"+_toHtml(a)+"' +",t)}}},TypeScriptGenerator.prototype._addRenderLine=function(e,t){var i=this;if("js-view"===e.tagName)i._addLine("this."+e.getAttribute("js-name")+".renderHtml() +",t);else{var n=(e.nodeType,e.tagName),a=e.annotation,r=e.childNodes.length>0||a&&(a.html||a.text||a.repeat),d=r?">' +":"></"+n+">' +";i._addLine("'<"+n+this._getIdAttribute(e)+this._getCreationMethod(e,"_genStyle","css","style")+this._getCreationMethod(e,"_genClass","className","class")+this._getCreationMethod(e,"_genAttr","attr")+this._getRemainingAttributes(e)+d,t),r&&(i._addElementContent(e,t+1)&&i._addChildNodes(e,t+1),i._addLine("'</"+n+">' +",t))}},TypeScriptGenerator.prototype._addElementContent=function(e,t){var i=e.annotation,n=!0;return i&&(i.text&&this._addLine("this._genText('"+i.text+"') +",t),i.html&&this._addLine("this._genHtml('"+i.text+"') +",t)),n},TypeScriptGenerator.prototype._addAnnotations=function(e){var t=this,i=[];for(var n in e.annotations)i.push(JSON.stringify(e.annotations[n],null,4));i.length&&(t._addLine(),t._addLine("_bindings = [",1),i.join(",\n").split("\n").forEach(function(e){t._addLine(e,2)}),t._addLine("];",1))},TypeScriptGenerator.prototype._getIdAttribute=function(e){var t="",i=e.annotation;return i&&(t=" id=\"' + this.id + '_"+i.id+'"'),t},TypeScriptGenerator.prototype._getCreationMethod=function(e,t,i,n){var a=e.annotation,r=a?a[i]:null,d="",o=[],s=e.getAttribute(n)||"";if(r){n&&e.removeAttribute(n),s="'"+s+"'";for(var p in r)o.push("'"+p+"'"),o.push("'"+r[p]+"'");d=" ' + this."+t+"("+s,o.length&&(d+=", ["+o.join(",")+"]"),d+=") + '"}return d},TypeScriptGenerator.prototype._getRemainingAttributes=function(e){for(var t=[],i=0;i<e.attributes.length;i++){var n=e.attributes[i];t.push(n.name+'="'+_toHtml(n.value)+'"')}return t.length?" "+t.join(" "):""},TypeScriptGenerator}(BaseGenerator);return TypeScriptGenerator});